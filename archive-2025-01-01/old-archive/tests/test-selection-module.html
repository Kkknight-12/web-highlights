<!DOCTYPE html>
<html>
<head>
    <title>Selection Module Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { color: green; }
        .error { color: red; }
        h2 { margin-top: 0; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            overflow-x: auto;
        }
        button {
            margin: 5px;
            padding: 8px 15px;
            cursor: pointer;
        }
        #test-content {
            padding: 20px;
            border: 2px solid #ccc;
            margin: 20px 0;
            background: white;
        }
        #selection-info {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 12px;
        }
        .input-test {
            margin: 10px 0;
        }
        input, textarea {
            width: 100%;
            padding: 5px;
            margin: 5px 0;
        }
        [contenteditable] {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>Chrome Web Highlighter - Selection Module Test</h1>
    
    <div class="test-section">
        <h2>Test Content Area</h2>
        <div id="test-content">
            <p id="test-p1">This is a test paragraph. Select any text here to test the selection module. The module should detect when you select text and provide information about the selection.</p>
            
            <p id="test-p2">Here's another paragraph with <strong>bold text</strong> and <em>italic text</em>. The selection module should handle complex DOM structures.</p>
            
            <div class="input-test">
                <label>Input Field (selection should be ignored):</label>
                <input type="text" value="Text in input field should not trigger selection events">
            </div>
            
            <div class="input-test">
                <label>Textarea (selection should be ignored):</label>
                <textarea>Text in textarea should not trigger selection events</textarea>
            </div>
            
            <div class="input-test">
                <label>ContentEditable (selection should be ignored):</label>
                <div contenteditable="true">This is contenteditable text - selection should be ignored</div>
            </div>
            
            <p id="test-p3">Final test paragraph. You can select text across multiple paragraphs to test range handling.</p>
        </div>
        
        <div id="selection-info">
            <strong>Selection Info:</strong> <span id="info-display">No selection</span>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Manual Test Controls</h2>
        <button onclick="programmaticSelect()">Select Text Programmatically</button>
        <button onclick="clearSelection()">Clear Selection</button>
        <button onclick="checkValidSelection()">Check Valid Selection</button>
        <button onclick="getSelectionInfo()">Get Selection Info</button>
        <div id="manual-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Automated Tests</h2>
        <button onclick="runAllTests()">Run All Tests</button>
        <div id="test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Event Log</h2>
        <button onclick="clearEventLog()">Clear Log</button>
        <div id="event-log"></div>
    </div>

    <!-- Load the modules -->
    <script src="src/core/EventBus.js"></script>
    <script src="src/core/StateManager.js"></script>
    <script src="src/core/Constants.js"></script>
    <script src="src/modules/selection.js"></script>
    
    <script>
        // Test utilities
        function log(message, isError = false, targetId = 'test-results') {
            const element = document.getElementById(targetId);
            const div = document.createElement('div');
            div.className = isError ? 'error' : 'success';
            div.textContent = message;
            element.appendChild(div);
        }
        
        function logEvent(event, data) {
            const element = document.getElementById('event-log');
            const div = document.createElement('div');
            div.innerHTML = `<strong>${event}:</strong> ${JSON.stringify(data, null, 2).substring(0, 200)}...`;
            element.appendChild(div);
        }
        
        function clearEventLog() {
            document.getElementById('event-log').innerHTML = '';
        }
        
        // Setup event listeners
        EventBus.on('selection:initialized', () => logEvent('selection:initialized', {}));
        EventBus.on('selection:changed', (data) => {
            logEvent('selection:changed', {
                text: data.text,
                bounds: data.bounds,
                startOffset: data.startOffset,
                endOffset: data.endOffset
            });
            updateSelectionInfo(data);
        });
        EventBus.on('selection:cleared', () => {
            logEvent('selection:cleared', {});
            document.getElementById('info-display').textContent = 'No selection';
        });
        
        // Initialize StateManager
        StateManager.register('selection', { 
            hasSelection: false, 
            selectedText: '', 
            selectionBounds: null, 
            isValid: false 
        });
        
        // Update selection info display
        function updateSelectionInfo(data) {
            const info = `Text: "${data.text}" | Length: ${data.text.length} | Bounds: ${data.bounds ? `${Math.round(data.bounds.width)}x${Math.round(data.bounds.height)}` : 'N/A'}`;
            document.getElementById('info-display').textContent = info;
        }
        
        // Manual test functions
        function programmaticSelect() {
            const p1 = document.getElementById('test-p1');
            SelectionModule.selectText(p1, 10, 30);
            log('Programmatically selected text in first paragraph', false, 'manual-results');
        }
        
        function clearSelection() {
            SelectionModule.clearBrowserSelection();
            SelectionModule.clearSelection();
            log('Selection cleared', false, 'manual-results');
        }
        
        function checkValidSelection() {
            const hasValid = SelectionModule.hasValidSelection();
            log(`Valid selection: ${hasValid}`, !hasValid, 'manual-results');
        }
        
        function getSelectionInfo() {
            const text = SelectionModule.getSelectedText();
            const range = SelectionModule.getSelectedRange();
            
            if (text) {
                log(`Selected text: "${text}"`, false, 'manual-results');
                if (range) {
                    log(`Range: ${range.startOffset} to ${range.endOffset}`, false, 'manual-results');
                }
            } else {
                log('No text selected', true, 'manual-results');
            }
        }
        
        // Automated test functions
        async function testInit() {
            try {
                await SelectionModule.init();
                log('✓ Selection module initialized');
                
                // Check state
                const state = StateManager.get('selection');
                if (!state.hasSelection) {
                    log('✓ Initial state correct');
                } else {
                    log('✗ Initial state should have no selection', true);
                }
            } catch (error) {
                log(`✗ Init failed: ${error.message}`, true);
            }
        }
        
        async function testProgrammaticSelection() {
            try {
                const testP = document.getElementById('test-p1');
                
                // Select text
                SelectionModule.selectText(testP, 5, 25);
                
                // Wait for selection to be processed
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const selectedText = SelectionModule.getSelectedText();
                if (selectedText.length > 0) {
                    log('✓ Programmatic selection works');
                    log(`  Selected: "${selectedText}"`);
                } else {
                    log('✗ Programmatic selection failed', true);
                }
                
                // Clear
                SelectionModule.clearBrowserSelection();
            } catch (error) {
                log(`✗ Programmatic selection test failed: ${error.message}`, true);
            }
        }
        
        async function testInputFieldValidation() {
            try {
                // Select text in input field
                const input = document.querySelector('input[type="text"]');
                input.select();
                
                // Trigger selection handler
                SelectionModule.handleTextSelection({ target: input });
                
                // Check state
                const state = StateManager.get('selection');
                if (!state.hasSelection) {
                    log('✓ Input field selection correctly ignored');
                } else {
                    log('✗ Input field selection should be ignored', true);
                }
                
                // Test textarea
                const textarea = document.querySelector('textarea');
                textarea.select();
                SelectionModule.handleTextSelection({ target: textarea });
                
                const state2 = StateManager.get('selection');
                if (!state2.hasSelection) {
                    log('✓ Textarea selection correctly ignored');
                } else {
                    log('✗ Textarea selection should be ignored', true);
                }
            } catch (error) {
                log(`✗ Input field validation test failed: ${error.message}`, true);
            }
        }
        
        async function testSelectionInfo() {
            try {
                // Create a selection programmatically
                const p2 = document.getElementById('test-p2');
                const textNode = p2.firstChild;
                
                const range = document.createRange();
                range.setStart(textNode, 0);
                range.setEnd(textNode, 20);
                
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                
                // Get selection info
                const info = SelectionModule.getSelectionInfo(selection, range);
                
                if (info.text && info.bounds && info.startOffset === 0 && info.endOffset === 20) {
                    log('✓ Selection info correctly extracted');
                    log(`  Text: "${info.text}"`);
                    log(`  Bounds: ${info.bounds.width}x${info.bounds.height}`);
                } else {
                    log('✗ Selection info incomplete', true);
                }
                
                selection.removeAllRanges();
            } catch (error) {
                log(`✗ Selection info test failed: ${error.message}`, true);
            }
        }
        
        async function testValidationEdgeCases() {
            try {
                // Test collapsed range
                const range = document.createRange();
                const p1 = document.getElementById('test-p1');
                range.setStart(p1.firstChild, 5);
                range.setEnd(p1.firstChild, 5);
                
                const isValid1 = SelectionModule.isValidSelection(range);
                if (!isValid1) {
                    log('✓ Collapsed range correctly identified as invalid');
                } else {
                    log('✗ Collapsed range should be invalid', true);
                }
                
                // Test empty text selection
                const emptyP = document.createElement('p');
                emptyP.textContent = '   ';
                document.body.appendChild(emptyP);
                
                const range2 = document.createRange();
                range2.selectNodeContents(emptyP);
                
                const isValid2 = SelectionModule.isValidSelection(range2);
                if (!isValid2) {
                    log('✓ Empty text selection correctly identified as invalid');
                } else {
                    log('✗ Empty text selection should be invalid', true);
                }
                
                document.body.removeChild(emptyP);
            } catch (error) {
                log(`✗ Validation edge cases test failed: ${error.message}`, true);
            }
        }
        
        async function runAllTests() {
            document.getElementById('test-results').innerHTML = '';
            
            log('=== Running Selection Module Tests ===');
            
            await testInit();
            await testProgrammaticSelection();
            await testInputFieldValidation();
            await testSelectionInfo();
            await testValidationEdgeCases();
            
            log('=== Tests Complete ===');
            
            // Check final state
            const state = StateManager.get('selection');
            log(`Final state: ${JSON.stringify(state)}`);
        }
        
        // Initialize on load
        window.addEventListener('load', async () => {
            await SelectionModule.init();
            log('Selection module initialized. Select text to see events.', false, 'manual-results');
        });
    </script>
</body>
</html>