<!DOCTYPE html>
<html>
<head>
    <title>HighlightButton Component Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { color: green; }
        .error { color: red; }
        h2 { margin-top: 0; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            overflow-x: auto;
        }
        button {
            margin: 5px;
            padding: 8px 15px;
            cursor: pointer;
        }
        
        /* Test areas with different backgrounds */
        .test-area {
            position: relative;
            padding: 40px;
            margin: 20px 0;
            border: 2px solid #ddd;
            min-height: 100px;
        }
        
        .light-bg {
            background: #ffffff;
            color: #000000;
        }
        
        .dark-bg {
            background: #1f2937;
            color: #ffffff;
        }
        
        .colored-bg {
            background: #3b82f6;
            color: #ffffff;
        }
        
        .gradient-bg {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
        }
        
        /* Selectable text */
        .selectable-text {
            font-size: 16px;
            line-height: 1.8;
            user-select: text;
        }
        
        #component-info {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Chrome Web Highlighter - HighlightButton Component Test</h1>
    
    <div class="test-section">
        <h2>Component Status</h2>
        <div id="component-info">
            <div><strong>Instances:</strong> <span id="instance-count">0</span></div>
            <div><strong>Current Color:</strong> <span id="current-color">yellow</span></div>
            <div><strong>Visible:</strong> <span id="is-visible">false</span></div>
            <div><strong>Color Picker:</strong> <span id="picker-visible">false</span></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Manual Controls</h2>
        <button onclick="createButton()">Create Button Instance</button>
        <button onclick="showButton()">Show Button</button>
        <button onclick="hideButton()">Hide Button</button>
        <button onclick="removeAllButtons()">Remove All Buttons</button>
        <button onclick="simulateSelection()">Simulate Text Selection</button>
        <div id="manual-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Test Areas - Select Text to Show Button</h2>
        
        <div class="test-area light-bg">
            <h3>Light Background</h3>
            <p class="selectable-text">
                Select this text to test the highlight button on a light background. 
                The button should appear with dark text and proper contrast.
                You can select multiple words or entire sentences.
            </p>
        </div>
        
        <div class="test-area dark-bg">
            <h3>Dark Background</h3>
            <p class="selectable-text">
                Select this text to test the highlight button on a dark background. 
                The button should automatically adjust its colors for better visibility.
                The component detects the background color and adapts accordingly.
            </p>
        </div>
        
        <div class="test-area colored-bg">
            <h3>Colored Background</h3>
            <p class="selectable-text">
                Select this text to test the highlight button on a colored background. 
                The automatic color adjustment should work here too.
            </p>
        </div>
        
        <div class="test-area gradient-bg">
            <h3>Gradient Background</h3>
            <p class="selectable-text">
                Select this text to test the highlight button on a gradient background. 
                This tests edge cases for background color detection.
            </p>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Automated Tests</h2>
        <button onclick="runAllTests()">Run All Tests</button>
        <div id="test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Event Log</h2>
        <button onclick="clearEventLog()">Clear Log</button>
        <div id="event-log"></div>
    </div>

    <!-- Load the modules -->
    <script src="src/core/EventBus.js"></script>
    <script src="src/core/StateManager.js"></script>
    <script src="src/core/Constants.js"></script>
    <script src="src/ui/HighlightButton.js"></script>
    
    <script>
        // Test utilities
        let buttonInstance = null;
        
        function log(message, isError = false, targetId = 'test-results') {
            const element = document.getElementById(targetId);
            const div = document.createElement('div');
            div.className = isError ? 'error' : 'success';
            div.textContent = message;
            element.appendChild(div);
        }
        
        function logEvent(event, data) {
            const element = document.getElementById('event-log');
            const div = document.createElement('div');
            div.innerHTML = `<strong>${event}:</strong> ${JSON.stringify(data, null, 2).substring(0, 200)}...`;
            element.appendChild(div);
        }
        
        function clearEventLog() {
            document.getElementById('event-log').innerHTML = '';
        }
        
        function updateComponentInfo() {
            const buttons = document.querySelectorAll('highlight-button');
            document.getElementById('instance-count').textContent = buttons.length;
            
            if (buttonInstance) {
                document.getElementById('current-color').textContent = buttonInstance.selectedColor;
                document.getElementById('is-visible').textContent = buttonInstance.isVisible;
                document.getElementById('picker-visible').textContent = buttonInstance.colorPickerVisible;
            }
        }
        
        // Setup event listeners
        EventBus.on('highlightButton:initialized', () => {
            logEvent('highlightButton:initialized', {});
            updateComponentInfo();
        });
        
        EventBus.on('highlightButton:shown', (data) => {
            logEvent('highlightButton:shown', data);
            updateComponentInfo();
        });
        
        EventBus.on('highlightButton:hidden', () => {
            logEvent('highlightButton:hidden', {});
            updateComponentInfo();
        });
        
        EventBus.on('highlightButton:clicked', (data) => {
            logEvent('highlightButton:clicked', data);
            log(`Button clicked with color: ${data.color}`, false, 'manual-results');
        });
        
        EventBus.on('color:changed', (data) => {
            logEvent('color:changed', data);
            updateComponentInfo();
        });
        
        // Initialize StateManager
        StateManager.register('ui', { 
            selectedColor: 'yellow',
            buttonVisible: false
        });
        
        // Manual control functions
        function createButton() {
            if (buttonInstance) {
                log('Button already exists', true, 'manual-results');
                return;
            }
            
            buttonInstance = document.createElement('highlight-button');
            document.body.appendChild(buttonInstance);
            log('Button created', false, 'manual-results');
            updateComponentInfo();
        }
        
        function showButton() {
            if (!buttonInstance) {
                createButton();
            }
            
            // Show at center of viewport
            const rect = {
                left: window.innerWidth / 2 - 50,
                bottom: window.innerHeight / 2,
                right: window.innerWidth / 2 + 50,
                top: window.innerHeight / 2 - 50
            };
            
            buttonInstance.show(rect);
            log('Button shown', false, 'manual-results');
        }
        
        function hideButton() {
            if (!buttonInstance) {
                log('No button to hide', true, 'manual-results');
                return;
            }
            
            buttonInstance.hide();
            log('Button hidden', false, 'manual-results');
        }
        
        function removeAllButtons() {
            document.querySelectorAll('highlight-button').forEach(btn => btn.remove());
            buttonInstance = null;
            log('All buttons removed', false, 'manual-results');
            updateComponentInfo();
        }
        
        function simulateSelection() {
            const textElement = document.querySelector('.light-bg .selectable-text');
            const textNode = textElement.firstChild;
            
            const range = document.createRange();
            range.setStart(textNode, 10);
            range.setEnd(textNode, 50);
            
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            // Get selection bounds
            const rect = range.getBoundingClientRect();
            
            // Show button
            if (!buttonInstance) createButton();
            buttonInstance.show(rect);
            
            log('Simulated selection and showed button', false, 'manual-results');
        }
        
        // Listen for text selection
        document.addEventListener('mouseup', (e) => {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (selectedText.length > 0) {
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                
                if (!buttonInstance) createButton();
                buttonInstance.show(rect);
            } else if (buttonInstance) {
                buttonInstance.hide();
            }
        });
        
        // Automated tests
        async function testComponentCreation() {
            try {
                const button = document.createElement('highlight-button');
                document.body.appendChild(button);
                
                // Check shadow DOM
                if (button.shadowRoot) {
                    log('✓ Component created with shadow DOM');
                } else {
                    log('✗ Shadow DOM not created', true);
                }
                
                // Check initial state
                if (button.selectedColor === 'yellow' && !button.isVisible) {
                    log('✓ Initial state correct');
                } else {
                    log('✗ Initial state incorrect', true);
                }
                
                button.remove();
            } catch (error) {
                log(`✗ Component creation failed: ${error.message}`, true);
            }
        }
        
        async function testShowHide() {
            try {
                const button = document.createElement('highlight-button');
                document.body.appendChild(button);
                
                const rect = { left: 100, bottom: 100, right: 200, top: 50 };
                
                // Test show
                button.show(rect);
                if (button.isVisible && button.style.display === 'flex') {
                    log('✓ Show method works');
                } else {
                    log('✗ Show method failed', true);
                }
                
                // Test hide
                button.hide();
                await new Promise(resolve => setTimeout(resolve, 100));
                
                if (!button.isVisible && button.style.display === 'none') {
                    log('✓ Hide method works');
                } else {
                    log('✗ Hide method failed', true);
                }
                
                button.remove();
            } catch (error) {
                log(`✗ Show/hide test failed: ${error.message}`, true);
            }
        }
        
        async function testColorSelection() {
            try {
                const button = document.createElement('highlight-button');
                document.body.appendChild(button);
                
                // Show button
                button.show({ left: 100, bottom: 100, right: 200, top: 50 });
                
                // Simulate color picker hover
                button.showColorPicker();
                await new Promise(resolve => setTimeout(resolve, 100));
                
                if (button.colorPickerVisible) {
                    log('✓ Color picker shows on hover');
                } else {
                    log('✗ Color picker hover failed', true);
                }
                
                // Change color
                const greenBtn = button.shadowRoot.querySelector('[data-color="green"]');
                if (greenBtn) {
                    greenBtn.click();
                    
                    if (button.selectedColor === 'green') {
                        log('✓ Color selection works');
                    } else {
                        log('✗ Color selection failed', true);
                    }
                }
                
                button.remove();
            } catch (error) {
                log(`✗ Color selection test failed: ${error.message}`, true);
            }
        }
        
        async function testBackgroundAdaptation() {
            try {
                const button = document.createElement('highlight-button');
                document.body.appendChild(button);
                
                // Position over dark background
                const darkArea = document.querySelector('.dark-bg');
                const rect = darkArea.getBoundingClientRect();
                button.show(rect);
                
                await new Promise(resolve => setTimeout(resolve, 100));
                
                if (button.classList.contains('dark-bg')) {
                    log('✓ Background adaptation works');
                } else {
                    log('✗ Background adaptation failed', true);
                }
                
                button.remove();
            } catch (error) {
                log(`✗ Background adaptation test failed: ${error.message}`, true);
            }
        }
        
        async function testEventIntegration() {
            try {
                const button = document.createElement('highlight-button');
                document.body.appendChild(button);
                
                let eventFired = false;
                
                // Listen for button click event
                const unsubscribe = EventBus.on('highlightButton:clicked', (data) => {
                    eventFired = true;
                });
                
                // Show and click button
                button.show({ left: 100, bottom: 100, right: 200, top: 50 });
                const btn = button.shadowRoot.querySelector('.highlight-button');
                btn.click();
                
                await new Promise(resolve => setTimeout(resolve, 100));
                
                if (eventFired) {
                    log('✓ Event integration works');
                } else {
                    log('✗ Event integration failed', true);
                }
                
                unsubscribe();
                button.remove();
            } catch (error) {
                log(`✗ Event integration test failed: ${error.message}`, true);
            }
        }
        
        async function runAllTests() {
            document.getElementById('test-results').innerHTML = '';
            
            log('=== Running HighlightButton Component Tests ===');
            
            await testComponentCreation();
            await testShowHide();
            await testColorSelection();
            await testBackgroundAdaptation();
            await testEventIntegration();
            
            log('=== Tests Complete ===');
            
            updateComponentInfo();
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            log('HighlightButton component test ready. Select text or use controls.', false, 'manual-results');
            updateComponentInfo();
        });
        
        // Update info periodically
        setInterval(updateComponentInfo, 1000);
    </script>
</body>
</html>