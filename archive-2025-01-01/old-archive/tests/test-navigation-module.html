<!DOCTYPE html>
<html>
<head>
    <title>Navigation Module Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { color: green; }
        .error { color: red; }
        h2 { margin-top: 0; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            overflow-x: auto;
        }
        button {
            margin: 5px;
            padding: 8px 15px;
            cursor: pointer;
        }
        #navigation-info {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 12px;
        }
        .url-test {
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>Chrome Web Highlighter - Navigation Module Test</h1>
    
    <div class="test-section">
        <h2>Current Navigation State</h2>
        <div id="navigation-info">
            <div><strong>Current URL:</strong> <span id="current-url"></span></div>
            <div><strong>Previous URL:</strong> <span id="previous-url">None</span></div>
            <div><strong>Navigation Count:</strong> <span id="nav-count">0</span></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Manual Navigation Tests</h2>
        <button onclick="navigateWithPushState()">Navigate with pushState</button>
        <button onclick="navigateWithReplaceState()">Navigate with replaceState</button>
        <button onclick="navigateWithHash()">Navigate with Hash</button>
        <button onclick="navigateBack()">Go Back</button>
        <button onclick="forceCheck()">Force Navigation Check</button>
        <div id="manual-results"></div>
    </div>
    
    <div class="test-section">
        <h2>URL Matching Tests</h2>
        <div class="url-test">
            <input type="text" id="url1" placeholder="First URL" style="width: 100%;">
            <input type="text" id="url2" placeholder="Second URL" style="width: 100%;">
            <button onclick="testUrlMatch()">Test Match</button>
            <div id="match-result"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Automated Tests</h2>
        <button onclick="runAllTests()">Run All Tests</button>
        <div id="test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Event Log</h2>
        <button onclick="clearEventLog()">Clear Log</button>
        <div id="event-log"></div>
    </div>

    <!-- Load the modules -->
    <script src="src/core/EventBus.js"></script>
    <script src="src/core/StateManager.js"></script>
    <script src="src/core/Constants.js"></script>
    <script src="src/modules/navigation.js"></script>
    
    <script>
        // Test utilities
        let navigationCount = 0;
        
        function log(message, isError = false, targetId = 'test-results') {
            const element = document.getElementById(targetId);
            const div = document.createElement('div');
            div.className = isError ? 'error' : 'success';
            div.textContent = message;
            element.appendChild(div);
        }
        
        function logEvent(event, data) {
            const element = document.getElementById('event-log');
            const div = document.createElement('div');
            div.innerHTML = `<strong>${event}:</strong> ${JSON.stringify(data, null, 2).substring(0, 200)}...`;
            element.appendChild(div);
        }
        
        function clearEventLog() {
            document.getElementById('event-log').innerHTML = '';
        }
        
        function updateNavigationInfo(data) {
            document.getElementById('current-url').textContent = data.currentUrl || window.location.href;
            document.getElementById('previous-url').textContent = data.previousUrl || 'None';
            document.getElementById('nav-count').textContent = ++navigationCount;
        }
        
        // Setup event listeners
        EventBus.on('navigation:initialized', () => logEvent('navigation:initialized', {}));
        EventBus.on('navigation:changed', (data) => {
            logEvent('navigation:changed', data);
            updateNavigationInfo(data);
        });
        
        // Initialize StateManager
        StateManager.register('navigation', { 
            currentUrl: window.location.href,
            previousUrl: null,
            framework: 'unknown',
            lastNavigationTime: Date.now()
        });
        
        // Manual test functions
        function navigateWithPushState() {
            const newPath = `/test-${Date.now()}`;
            history.pushState({}, '', newPath);
            log(`Navigated to: ${window.location.href}`, false, 'manual-results');
        }
        
        function navigateWithReplaceState() {
            const newPath = `/replace-${Date.now()}`;
            history.replaceState({}, '', newPath);
            log(`Replaced state to: ${window.location.href}`, false, 'manual-results');
        }
        
        function navigateWithHash() {
            window.location.hash = `#test-${Date.now()}`;
            log(`Changed hash to: ${window.location.hash}`, false, 'manual-results');
        }
        
        function navigateBack() {
            history.back();
            log('Navigated back', false, 'manual-results');
        }
        
        function forceCheck() {
            NavigationModule.checkNavigation();
            log('Forced navigation check', false, 'manual-results');
        }
        
        function testUrlMatch() {
            const url1 = document.getElementById('url1').value;
            const url2 = document.getElementById('url2').value;
            
            if (!url1 || !url2) {
                log('Please enter both URLs', true, 'match-result');
                return;
            }
            
            const matches = NavigationModule.urlsMatch(url1, url2);
            const normalized1 = NavigationModule.getStorageUrl(url1);
            const normalized2 = NavigationModule.getStorageUrl(url2);
            
            document.getElementById('match-result').innerHTML = `
                <div class="${matches ? 'success' : 'error'}">Match: ${matches}</div>
                <div>Normalized URL 1: ${normalized1}</div>
                <div>Normalized URL 2: ${normalized2}</div>
            `;
        }
        
        // Automated test functions
        async function testInit() {
            try {
                await NavigationModule.init();
                log('✓ Navigation module initialized');
                
                // Check initial state
                const currentUrl = NavigationModule.getCurrentUrl();
                if (currentUrl === window.location.href) {
                    log('✓ Current URL correctly tracked');
                } else {
                    log('✗ Current URL mismatch', true);
                }
            } catch (error) {
                log(`✗ Init failed: ${error.message}`, true);
            }
        }
        
        async function testNavigationDetection() {
            try {
                let navigationDetected = false;
                
                // Register listener
                const unsubscribe = NavigationModule.onNavigation(() => {
                    navigationDetected = true;
                });
                
                // Trigger navigation
                const oldUrl = window.location.href;
                history.pushState({}, '', '/test-navigation-detection');
                
                // Wait for detection
                await new Promise(resolve => setTimeout(resolve, 100));
                
                if (navigationDetected) {
                    log('✓ Navigation detection works');
                } else {
                    log('✗ Navigation not detected', true);
                }
                
                // Cleanup
                history.pushState({}, '', oldUrl);
                unsubscribe();
            } catch (error) {
                log(`✗ Navigation detection test failed: ${error.message}`, true);
            }
        }
        
        async function testUrlMatching() {
            try {
                // Test exact match
                const url = 'https://example.com/page';
                if (NavigationModule.urlsMatch(url, url)) {
                    log('✓ Exact URL match works');
                } else {
                    log('✗ Exact URL match failed', true);
                }
                
                // Test normalized match
                const url1 = 'https://example.com/page/';
                const url2 = 'https://example.com/page';
                if (NavigationModule.urlsMatch(url1, url2)) {
                    log('✓ Normalized URL match works');
                } else {
                    log('✗ Normalized URL match failed', true);
                }
                
                // Test with query params
                const url3 = 'https://example.com/page?a=1&b=2';
                const url4 = 'https://example.com/page?b=2&a=1';
                if (NavigationModule.urlsMatch(url3, url4)) {
                    log('✓ Query param order normalization works');
                } else {
                    log('✗ Query param normalization failed', true);
                }
                
                // Test different pages
                const url5 = 'https://example.com/page1';
                const url6 = 'https://example.com/page2';
                if (!NavigationModule.urlsMatch(url5, url6)) {
                    log('✓ Different pages correctly identified');
                } else {
                    log('✗ Different pages incorrectly matched', true);
                }
            } catch (error) {
                log(`✗ URL matching test failed: ${error.message}`, true);
            }
        }
        
        async function testFilterHighlights() {
            try {
                const currentUrl = 'https://example.com/test';
                const highlights = [
                    { id: '1', url: 'https://example.com/test', text: 'Test 1' },
                    { id: '2', url: 'https://example.com/other', text: 'Test 2' },
                    { id: '3', url: 'https://example.com/test/', text: 'Test 3' },
                    { id: '4', url: 'https://different.com/test', text: 'Test 4' }
                ];
                
                const filtered = NavigationModule.filterHighlightsByUrl(highlights, currentUrl);
                
                if (filtered.length === 2 && filtered[0].id === '1' && filtered[1].id === '3') {
                    log('✓ Highlight filtering works correctly');
                    log(`  Filtered ${highlights.length} highlights to ${filtered.length}`);
                } else {
                    log('✗ Highlight filtering incorrect', true);
                }
            } catch (error) {
                log(`✗ Filter highlights test failed: ${error.message}`, true);
            }
        }
        
        async function testDifferentPage() {
            try {
                const tests = [
                    { url1: 'https://example.com/page1', url2: 'https://example.com/page2', expected: true },
                    { url1: 'https://example.com/page', url2: 'https://example.com/page#hash', expected: false },
                    { url1: 'https://example.com/page', url2: 'https://example.com/page?query=1', expected: false },
                    { url1: 'https://example.com/page', url2: 'https://different.com/page', expected: true }
                ];
                
                let allPassed = true;
                tests.forEach(test => {
                    // Simulate being on url1
                    NavigationModule.checkNavigation();
                    const isDifferent = NavigationModule.isDifferentPage(test.url2);
                    if (isDifferent !== test.expected) {
                        allPassed = false;
                        log(`✗ isDifferentPage failed for ${test.url1} -> ${test.url2}`, true);
                    }
                });
                
                if (allPassed) {
                    log('✓ Different page detection works');
                }
            } catch (error) {
                log(`✗ Different page test failed: ${error.message}`, true);
            }
        }
        
        async function testStats() {
            try {
                const stats = NavigationModule.getStats();
                log('✓ Navigation stats retrieved:');
                console.log('Stats:', stats);
                
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(stats, null, 2);
                document.getElementById('test-results').appendChild(pre);
            } catch (error) {
                log(`✗ Stats test failed: ${error.message}`, true);
            }
        }
        
        async function runAllTests() {
            document.getElementById('test-results').innerHTML = '';
            
            log('=== Running Navigation Module Tests ===');
            
            await testInit();
            await testNavigationDetection();
            await testUrlMatching();
            await testFilterHighlights();
            await testDifferentPage();
            await testStats();
            
            log('=== Tests Complete ===');
        }
        
        // Initialize on load
        window.addEventListener('load', async () => {
            await NavigationModule.init();
            updateNavigationInfo({ currentUrl: window.location.href });
            log('Navigation module initialized. Use buttons to test navigation.', false, 'manual-results');
        });
        
        // Add some test URLs to the matching inputs
        window.addEventListener('load', () => {
            document.getElementById('url1').value = 'https://example.com/page?param=1';
            document.getElementById('url2').value = 'https://example.com/page/?param=1';
        });
    </script>
</body>
</html>