<!DOCTYPE html>
<html>
<head>
    <title>MiniToolbar Component Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { color: green; }
        .error { color: red; }
        h2 { margin-top: 0; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            overflow-x: auto;
        }
        button {
            margin: 5px;
            padding: 8px 15px;
            cursor: pointer;
        }
        
        /* Test highlights */
        .web-highlighter-highlight {
            background-color: rgba(255, 224, 102, 0.4);
            border-bottom: 2px solid rgba(255, 224, 102, 0.8);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .web-highlighter-highlight:hover {
            filter: brightness(0.9);
        }
        
        /* Test areas with different backgrounds */
        .test-area {
            position: relative;
            padding: 40px;
            margin: 20px 0;
            border: 2px solid #ddd;
            min-height: 100px;
        }
        
        .light-bg {
            background: #ffffff;
            color: #000000;
        }
        
        .dark-bg {
            background: #1f2937;
            color: #ffffff;
        }
        
        .colored-bg {
            background: #3b82f6;
            color: #ffffff;
        }
        
        #component-info {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .test-highlight {
            display: inline-block;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Chrome Web Highlighter - MiniToolbar Component Test</h1>
    
    <div class="test-section">
        <h2>Component Status</h2>
        <div id="component-info">
            <div><strong>Instances:</strong> <span id="instance-count">0</span></div>
            <div><strong>Visible:</strong> <span id="is-visible">false</span></div>
            <div><strong>Current Highlight ID:</strong> <span id="current-highlight">none</span></div>
            <div><strong>Current Text:</strong> <span id="current-text">none</span></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Manual Controls</h2>
        <button onclick="createToolbar()">Create Toolbar Instance</button>
        <button onclick="showToolbar()">Show Toolbar</button>
        <button onclick="hideToolbar()">Hide Toolbar</button>
        <button onclick="removeAllToolbars()">Remove All Toolbars</button>
        <button onclick="simulateHighlightClick()">Simulate Highlight Click</button>
        <div id="manual-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Test Highlights - Click to Show Toolbar</h2>
        
        <div class="test-area light-bg">
            <h3>Light Background</h3>
            <p>
                Here's some text with 
                <span class="web-highlighter-highlight test-highlight" data-highlight-id="test-1">a highlighted section</span>
                that you can click on. The toolbar should appear with proper styling.
            </p>
            <p>
                Another paragraph with 
                <span class="web-highlighter-highlight test-highlight" data-highlight-id="test-2" style="background-color: rgba(110, 231, 183, 0.4); border-color: rgba(110, 231, 183, 0.8);">green highlight</span>
                to test different colors.
            </p>
        </div>
        
        <div class="test-area dark-bg">
            <h3>Dark Background</h3>
            <p>
                Dark mode test with 
                <span class="web-highlighter-highlight test-highlight" data-highlight-id="test-3">highlighted text here</span>.
                The toolbar should adapt its colors.
            </p>
        </div>
        
        <div class="test-area colored-bg">
            <h3>Colored Background</h3>
            <p>
                Colored background with 
                <span class="web-highlighter-highlight test-highlight" data-highlight-id="test-4">another highlight</span>
                for edge case testing.
            </p>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Automated Tests</h2>
        <button onclick="runAllTests()">Run All Tests</button>
        <div id="test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Event Log</h2>
        <button onclick="clearEventLog()">Clear Log</button>
        <div id="event-log"></div>
    </div>

    <!-- Load the modules -->
    <script src="src/core/EventBus.js"></script>
    <script src="src/core/StateManager.js"></script>
    <script src="src/core/Constants.js"></script>
    <script src="src/ui/MiniToolbar.js"></script>
    
    <script>
        // Test utilities
        let toolbarInstance = null;
        
        function log(message, isError = false, targetId = 'test-results') {
            const element = document.getElementById(targetId);
            const div = document.createElement('div');
            div.className = isError ? 'error' : 'success';
            div.textContent = message;
            element.appendChild(div);
        }
        
        function logEvent(event, data) {
            const element = document.getElementById('event-log');
            const div = document.createElement('div');
            div.innerHTML = `<strong>${event}:</strong> ${JSON.stringify(data, null, 2).substring(0, 200)}...`;
            element.appendChild(div);
        }
        
        function clearEventLog() {
            document.getElementById('event-log').innerHTML = '';
        }
        
        function updateComponentInfo() {
            const toolbars = document.querySelectorAll('mini-toolbar');
            document.getElementById('instance-count').textContent = toolbars.length;
            
            if (toolbarInstance) {
                document.getElementById('is-visible').textContent = toolbarInstance.isVisible;
                document.getElementById('current-highlight').textContent = toolbarInstance.currentHighlightId || 'none';
                document.getElementById('current-text').textContent = toolbarInstance.currentHighlightText || 'none';
            }
        }
        
        // Setup event listeners
        EventBus.on('miniToolbar:initialized', () => {
            logEvent('miniToolbar:initialized', {});
            updateComponentInfo();
        });
        
        EventBus.on('miniToolbar:shown', (data) => {
            logEvent('miniToolbar:shown', data);
            updateComponentInfo();
        });
        
        EventBus.on('miniToolbar:hidden', () => {
            logEvent('miniToolbar:hidden', {});
            updateComponentInfo();
        });
        
        EventBus.on('miniToolbar:action', (data) => {
            logEvent('miniToolbar:action', data);
            log(`Action: ${data.action} on highlight ${data.highlightId}`, false, 'manual-results');
        });
        
        EventBus.on('miniToolbar:copied', (data) => {
            logEvent('miniToolbar:copied', data);
            log(`Copied: "${data.text}"`, false, 'manual-results');
        });
        
        EventBus.on('miniToolbar:removeRequest', (data) => {
            logEvent('miniToolbar:removeRequest', data);
            // Simulate highlight removal
            const highlight = document.querySelector(`[data-highlight-id="${data.highlightId}"]`);
            if (highlight) {
                highlight.style.textDecoration = 'line-through';
                highlight.style.opacity = '0.5';
                setTimeout(() => {
                    const text = highlight.textContent;
                    highlight.replaceWith(text);
                    EventBus.emit('highlight:removed', { id: data.highlightId });
                }, 300);
            }
        });
        
        EventBus.on('miniToolbar:noteRequest', (data) => {
            logEvent('miniToolbar:noteRequest', data);
            log(`Note requested for highlight ${data.highlightId}`, false, 'manual-results');
        });
        
        EventBus.on('miniToolbar:colorRequest', (data) => {
            logEvent('miniToolbar:colorRequest', data);
            log(`Color change requested for highlight ${data.highlightId}`, false, 'manual-results');
        });
        
        // Initialize StateManager
        StateManager.register('miniToolbar', { 
            currentHighlightId: null,
            currentHighlightText: ''
        });
        
        // Manual control functions
        function createToolbar() {
            if (toolbarInstance) {
                log('Toolbar already exists', true, 'manual-results');
                return;
            }
            
            toolbarInstance = document.createElement('mini-toolbar');
            document.body.appendChild(toolbarInstance);
            log('Toolbar created', false, 'manual-results');
            updateComponentInfo();
        }
        
        function showToolbar() {
            if (!toolbarInstance) {
                createToolbar();
            }
            
            // Show at center of viewport
            const rect = {
                left: window.innerWidth / 2 - 50,
                bottom: window.innerHeight / 2,
                right: window.innerWidth / 2 + 50,
                top: window.innerHeight / 2 - 50
            };
            
            toolbarInstance.show(rect, 'manual-test', 'Manual test highlight');
            log('Toolbar shown', false, 'manual-results');
        }
        
        function hideToolbar() {
            if (!toolbarInstance) {
                log('No toolbar to hide', true, 'manual-results');
                return;
            }
            
            toolbarInstance.hide();
            log('Toolbar hidden', false, 'manual-results');
        }
        
        function removeAllToolbars() {
            document.querySelectorAll('mini-toolbar').forEach(toolbar => toolbar.remove());
            toolbarInstance = null;
            log('All toolbars removed', false, 'manual-results');
            updateComponentInfo();
        }
        
        function simulateHighlightClick() {
            const highlight = document.querySelector('.test-highlight');
            if (highlight) {
                highlight.click();
                log('Simulated click on first highlight', false, 'manual-results');
            } else {
                log('No highlights found', true, 'manual-results');
            }
        }
        
        // Setup highlight click handlers
        document.addEventListener('click', (e) => {
            const highlight = e.target.closest('.web-highlighter-highlight');
            if (highlight) {
                e.preventDefault();
                e.stopPropagation();
                
                if (!toolbarInstance) createToolbar();
                
                const rect = highlight.getBoundingClientRect();
                const highlightId = highlight.dataset.highlightId;
                const highlightText = highlight.textContent;
                
                toolbarInstance.show(rect, highlightId, highlightText);
            }
        });
        
        // Automated tests
        async function testComponentCreation() {
            try {
                const toolbar = document.createElement('mini-toolbar');
                document.body.appendChild(toolbar);
                
                // Check shadow DOM
                if (toolbar.shadowRoot) {
                    log('✓ Component created with shadow DOM');
                } else {
                    log('✗ Shadow DOM not created', true);
                }
                
                // Check initial state
                if (!toolbar.isVisible && !toolbar.currentHighlightId) {
                    log('✓ Initial state correct');
                } else {
                    log('✗ Initial state incorrect', true);
                }
                
                toolbar.remove();
            } catch (error) {
                log(`✗ Component creation failed: ${error.message}`, true);
            }
        }
        
        async function testShowHide() {
            try {
                const toolbar = document.createElement('mini-toolbar');
                document.body.appendChild(toolbar);
                
                const rect = { left: 100, bottom: 100, right: 200, top: 50 };
                
                // Test show
                toolbar.show(rect, 'test-123', 'Test highlight text');
                if (toolbar.isVisible && toolbar.style.display === 'block') {
                    log('✓ Show method works');
                } else {
                    log('✗ Show method failed', true);
                }
                
                // Check highlight data
                if (toolbar.currentHighlightId === 'test-123' && 
                    toolbar.currentHighlightText === 'Test highlight text') {
                    log('✓ Highlight data stored correctly');
                } else {
                    log('✗ Highlight data storage failed', true);
                }
                
                // Test hide
                toolbar.hide();
                if (!toolbar.isVisible && toolbar.style.display === 'none') {
                    log('✓ Hide method works');
                } else {
                    log('✗ Hide method failed', true);
                }
                
                toolbar.remove();
            } catch (error) {
                log(`✗ Show/hide test failed: ${error.message}`, true);
            }
        }
        
        async function testActions() {
            try {
                const toolbar = document.createElement('mini-toolbar');
                document.body.appendChild(toolbar);
                
                let actionFired = false;
                let copiedText = '';
                
                // Listen for events
                const unsubAction = EventBus.on('miniToolbar:action', (data) => {
                    actionFired = true;
                });
                
                const unsubCopy = EventBus.on('miniToolbar:copied', (data) => {
                    copiedText = data.text;
                });
                
                // Show toolbar
                toolbar.show({ left: 100, bottom: 100 }, 'test-456', 'Copy this text');
                
                // Test copy button
                const copyBtn = toolbar.shadowRoot.querySelector('[data-action="copy"]');
                if (copyBtn) {
                    // Mock clipboard API
                    const originalClipboard = navigator.clipboard;
                    navigator.clipboard = {
                        writeText: async (text) => {
                            copiedText = text;
                            return Promise.resolve();
                        }
                    };
                    
                    copyBtn.click();
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    if (actionFired && copiedText === 'Copy this text') {
                        log('✓ Copy action works');
                    } else {
                        log('✗ Copy action failed', true);
                    }
                    
                    // Restore clipboard
                    navigator.clipboard = originalClipboard;
                }
                
                unsubAction();
                unsubCopy();
                toolbar.remove();
            } catch (error) {
                log(`✗ Actions test failed: ${error.message}`, true);
            }
        }
        
        async function testBackgroundAdaptation() {
            try {
                const toolbar = document.createElement('mini-toolbar');
                document.body.appendChild(toolbar);
                
                // Position over dark background
                const darkArea = document.querySelector('.dark-bg');
                const rect = darkArea.getBoundingClientRect();
                toolbar.show(rect, 'test-dark', 'Dark test');
                
                await new Promise(resolve => setTimeout(resolve, 100));
                
                if (toolbar.classList.contains('dark-bg')) {
                    log('✓ Background adaptation works');
                } else {
                    log('✗ Background adaptation failed', true);
                }
                
                toolbar.remove();
            } catch (error) {
                log(`✗ Background adaptation test failed: ${error.message}`, true);
            }
        }
        
        async function testViewportConstraints() {
            try {
                const toolbar = document.createElement('mini-toolbar');
                document.body.appendChild(toolbar);
                
                // Position near right edge
                const rect = {
                    left: window.innerWidth - 50,
                    bottom: 100,
                    right: window.innerWidth,
                    top: 50
                };
                
                toolbar.show(rect, 'test-viewport', 'Viewport test');
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const toolbarRect = toolbar.getBoundingClientRect();
                if (toolbarRect.right <= window.innerWidth) {
                    log('✓ Viewport constraints work');
                } else {
                    log('✗ Viewport constraints failed', true);
                }
                
                toolbar.remove();
            } catch (error) {
                log(`✗ Viewport constraints test failed: ${error.message}`, true);
            }
        }
        
        async function runAllTests() {
            document.getElementById('test-results').innerHTML = '';
            
            log('=== Running MiniToolbar Component Tests ===');
            
            await testComponentCreation();
            await testShowHide();
            await testActions();
            await testBackgroundAdaptation();
            await testViewportConstraints();
            
            log('=== Tests Complete ===');
            
            updateComponentInfo();
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            log('MiniToolbar component test ready. Click highlights or use controls.', false, 'manual-results');
            updateComponentInfo();
        });
        
        // Update info periodically
        setInterval(updateComponentInfo, 1000);
    </script>
</body>
</html>