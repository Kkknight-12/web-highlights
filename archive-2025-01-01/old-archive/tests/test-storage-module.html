<!DOCTYPE html>
<html>
<head>
    <title>Storage Module Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { color: green; }
        .error { color: red; }
        h2 { margin-top: 0; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            overflow-x: auto;
        }
        button {
            margin: 5px;
            padding: 8px 15px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Chrome Web Highlighter - Storage Module Test</h1>
    
    <div class="test-section">
        <h2>Mock Chrome Storage API</h2>
        <div id="mock-status"></div>
    </div>
    
    <div class="test-section">
        <h2>Storage Module Tests</h2>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearStorage()">Clear Storage</button>
        <div id="test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Event Log</h2>
        <button onclick="clearEventLog()">Clear Log</button>
        <div id="event-log"></div>
    </div>

    <!-- Mock Chrome Storage API -->
    <script>
        // Mock chrome.storage.local
        const mockStorage = {
            data: {},
            
            get(keys, callback) {
                return new Promise((resolve) => {
                    const result = {};
                    if (typeof keys === 'string') {
                        result[keys] = this.data[keys];
                    } else if (Array.isArray(keys)) {
                        keys.forEach(key => {
                            result[key] = this.data[key];
                        });
                    } else {
                        Object.assign(result, this.data);
                    }
                    if (callback) callback(result);
                    resolve(result);
                });
            },
            
            set(items, callback) {
                return new Promise((resolve) => {
                    Object.assign(this.data, items);
                    
                    // Trigger onChanged event
                    if (chrome.storage.onChanged._listeners.length > 0) {
                        const changes = {};
                        Object.keys(items).forEach(key => {
                            changes[key] = {
                                oldValue: this.data[key],
                                newValue: items[key]
                            };
                        });
                        chrome.storage.onChanged._listeners.forEach(listener => {
                            listener(changes, 'local');
                        });
                    }
                    
                    if (callback) callback();
                    resolve();
                });
            },
            
            clear(callback) {
                this.data = {};
                if (callback) callback();
                return Promise.resolve();
            }
        };

        // Create mock chrome object
        window.chrome = {
            runtime: {
                id: 'test-extension-id'
            },
            storage: {
                local: mockStorage,
                onChanged: {
                    _listeners: [],
                    addListener(callback) {
                        this._listeners.push(callback);
                    },
                    removeListener(callback) {
                        const index = this._listeners.indexOf(callback);
                        if (index > -1) {
                            this._listeners.splice(index, 1);
                        }
                    }
                }
            }
        };
        
        document.getElementById('mock-status').innerHTML = '<span class="success">✓ Chrome Storage API mocked successfully</span>';
    </script>

    <!-- Load the modules -->
    <script src="src/core/EventBus.js"></script>
    <script src="src/core/StateManager.js"></script>
    <script src="src/core/Constants.js"></script>
    <script src="src/modules/storage.js"></script>
    
    <script>
        // Test utilities
        function log(message, isError = false) {
            const element = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = isError ? 'error' : 'success';
            div.textContent = message;
            element.appendChild(div);
        }
        
        function logEvent(event, data) {
            const element = document.getElementById('event-log');
            const div = document.createElement('div');
            div.innerHTML = `<strong>${event}:</strong> ${JSON.stringify(data)}`;
            element.appendChild(div);
        }
        
        function clearEventLog() {
            document.getElementById('event-log').innerHTML = '';
        }
        
        // Setup event listeners
        EventBus.on('storage:initialized', () => logEvent('storage:initialized', {}));
        EventBus.on('storage:changed', (data) => logEvent('storage:changed', data));
        EventBus.on('storage:highlight:saved', (data) => logEvent('storage:highlight:saved', data));
        EventBus.on('storage:highlight:removed', (data) => logEvent('storage:highlight:removed', data));
        EventBus.on('storage:highlight:updated', (data) => logEvent('storage:highlight:updated', data));
        EventBus.on('storage:highlights:cleared', (data) => logEvent('storage:highlights:cleared', data));
        EventBus.on('storage:error', (data) => logEvent('storage:error', data));
        
        // Initialize StateManager
        StateManager.register('storage', { isLoading: false, lastError: null, highlightCount: 0 });
        
        // Test functions
        async function clearStorage() {
            await chrome.storage.local.clear();
            log('✓ Storage cleared');
        }
        
        async function testInit() {
            try {
                await StorageModule.init();
                log('✓ Storage module initialized');
            } catch (error) {
                log(`✗ Init failed: ${error.message}`, true);
            }
        }
        
        async function testSaveHighlight() {
            const highlight = {
                id: 'test-' + Date.now(),
                text: 'Test highlight text',
                url: 'https://example.com',
                color: 'yellow',
                timestamp: Date.now()
            };
            
            try {
                const success = await StorageModule.saveHighlight(highlight);
                if (success) {
                    log('✓ Highlight saved successfully');
                } else {
                    log('✗ Save returned false', true);
                }
            } catch (error) {
                log(`✗ Save failed: ${error.message}`, true);
            }
        }
        
        async function testGetHighlights() {
            try {
                const highlights = await StorageModule.getHighlights();
                log(`✓ Retrieved ${highlights.length} highlights`);
                console.log('Highlights:', highlights);
            } catch (error) {
                log(`✗ Get highlights failed: ${error.message}`, true);
            }
        }
        
        async function testRemoveHighlight() {
            try {
                // First, get highlights to find one to remove
                const highlights = await StorageModule.getHighlights();
                if (highlights.length === 0) {
                    log('✗ No highlights to remove', true);
                    return;
                }
                
                const idToRemove = highlights[0].id;
                const success = await StorageModule.removeHighlight(idToRemove);
                
                if (success) {
                    log(`✓ Highlight ${idToRemove} removed`);
                } else {
                    log('✗ Remove returned false', true);
                }
            } catch (error) {
                log(`✗ Remove failed: ${error.message}`, true);
            }
        }
        
        async function testUpdateHighlight() {
            try {
                // First, save a highlight
                const highlight = {
                    id: 'update-test-' + Date.now(),
                    text: 'Original text',
                    url: 'https://example.com',
                    color: 'yellow'
                };
                
                await StorageModule.saveHighlight(highlight);
                
                // Then update it
                const success = await StorageModule.updateHighlight(highlight.id, {
                    color: 'blue',
                    note: 'Updated note'
                });
                
                if (success) {
                    log(`✓ Highlight ${highlight.id} updated`);
                } else {
                    log('✗ Update returned false', true);
                }
            } catch (error) {
                log(`✗ Update failed: ${error.message}`, true);
            }
        }
        
        async function testClearByUrl() {
            try {
                // First, save some highlights
                const url = 'https://test-clear.com';
                for (let i = 0; i < 3; i++) {
                    await StorageModule.saveHighlight({
                        id: 'clear-test-' + i,
                        text: 'Text ' + i,
                        url: url,
                        color: 'yellow'
                    });
                }
                
                // Clear highlights for this URL
                const count = await StorageModule.clearHighlightsByUrl(url);
                log(`✓ Cleared ${count} highlights for ${url}`);
            } catch (error) {
                log(`✗ Clear by URL failed: ${error.message}`, true);
            }
        }
        
        async function testStats() {
            try {
                const stats = await StorageModule.getStats();
                log('✓ Storage stats retrieved:');
                console.log('Stats:', stats);
                
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(stats, null, 2);
                document.getElementById('test-results').appendChild(pre);
            } catch (error) {
                log(`✗ Get stats failed: ${error.message}`, true);
            }
        }
        
        async function testValidation() {
            log('--- Testing validation ---');
            
            // Test invalid highlight (missing fields)
            try {
                await StorageModule.saveHighlight({ id: 'bad' });
                log('✗ Should have thrown error for invalid highlight', true);
            } catch (error) {
                log('✓ Correctly rejected invalid highlight');
            }
            
            // Test null highlight
            try {
                await StorageModule.saveHighlight(null);
                log('✗ Should have thrown error for null highlight', true);
            } catch (error) {
                log('✓ Correctly rejected null highlight');
            }
        }
        
        async function runAllTests() {
            document.getElementById('test-results').innerHTML = '';
            
            log('=== Running Storage Module Tests ===');
            
            await clearStorage();
            await testInit();
            await testSaveHighlight();
            await testGetHighlights();
            await testUpdateHighlight();
            await testRemoveHighlight();
            await testClearByUrl();
            await testStats();
            await testValidation();
            
            log('=== Tests Complete ===');
            
            // Check state
            const state = StateManager.get('storage');
            log(`Final state: ${JSON.stringify(state)}`);
        }
        
        // Initialize on load
        window.addEventListener('load', async () => {
            await StorageModule.init();
        });
    </script>
</body>
</html>