<!DOCTYPE html>
<html>
<head>
    <title>Core Modules Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { color: green; }
        .error { color: red; }
        h2 { margin-top: 0; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Chrome Web Highlighter - Core Modules Test</h1>
    
    <div id="eventbus-test" class="test-section">
        <h2>EventBus Module Test</h2>
        <div id="eventbus-results"></div>
    </div>
    
    <div id="statemanager-test" class="test-section">
        <h2>StateManager Module Test</h2>
        <div id="statemanager-results"></div>
    </div>
    
    <div id="constants-test" class="test-section">
        <h2>Constants Module Test</h2>
        <div id="constants-results"></div>
    </div>

    <!-- Load the modules -->
    <script src="src/core/EventBus.js"></script>
    <script src="src/core/StateManager.js"></script>
    <script src="src/core/Constants.js"></script>
    
    <script>
        // Test utilities
        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const div = document.createElement('div');
            div.className = isError ? 'error' : 'success';
            div.textContent = message;
            element.appendChild(div);
        }
        
        function logJson(elementId, obj) {
            const element = document.getElementById(elementId);
            const pre = document.createElement('pre');
            pre.textContent = JSON.stringify(obj, null, 2);
            element.appendChild(pre);
        }
        
        // Test EventBus
        function testEventBus() {
            const resultsId = 'eventbus-results';
            
            try {
                // Test 1: Basic event emission
                let eventReceived = false;
                EventBus.on('test:event', (data) => {
                    eventReceived = true;
                    log(resultsId, `✓ Event received with data: ${data}`);
                });
                
                EventBus.emit('test:event', 'Hello EventBus');
                
                if (!eventReceived) {
                    log(resultsId, '✗ Event not received', true);
                }
                
                // Test 2: Unsubscribe
                const unsubscribe = EventBus.on('test:unsub', () => {});
                const countBefore = EventBus.getHandlerCount('test:unsub');
                unsubscribe();
                const countAfter = EventBus.getHandlerCount('test:unsub');
                
                if (countBefore === 1 && countAfter === 0) {
                    log(resultsId, '✓ Unsubscribe works correctly');
                } else {
                    log(resultsId, '✗ Unsubscribe failed', true);
                }
                
                // Test 3: Once handler
                let onceCount = 0;
                EventBus.once('test:once', () => {
                    onceCount++;
                });
                
                EventBus.emit('test:once');
                EventBus.emit('test:once');
                
                if (onceCount === 1) {
                    log(resultsId, '✓ Once handler fired only once');
                } else {
                    log(resultsId, `✗ Once handler fired ${onceCount} times`, true);
                }
                
                // Test 4: Event history
                const history = EventBus.getHistory();
                log(resultsId, `✓ Event history contains ${history.length} events`);
                
                // Show registered events
                log(resultsId, `✓ Registered events: ${EventBus.getEvents().join(', ')}`);
                
            } catch (error) {
                log(resultsId, `✗ EventBus test error: ${error.message}`, true);
            }
        }
        
        // Test StateManager
        function testStateManager() {
            const resultsId = 'statemanager-results';
            
            try {
                // Test 1: Register module
                StateManager.register('testModule', { count: 0, name: 'Test' });
                log(resultsId, '✓ Module registered successfully');
                
                // Test 2: Get state
                const state = StateManager.get('testModule');
                logJson(resultsId, state);
                
                // Test 3: Set state
                StateManager.set('testModule', 'count', 5);
                const newCount = StateManager.get('testModule', 'count');
                
                if (newCount === 5) {
                    log(resultsId, '✓ State updated correctly');
                } else {
                    log(resultsId, '✗ State update failed', true);
                }
                
                // Test 4: Subscribe to changes
                let changeDetected = false;
                StateManager.subscribe('testModule', (change) => {
                    changeDetected = true;
                    log(resultsId, `✓ Change detected: ${change.key} = ${change.value}`);
                });
                
                StateManager.set('testModule', 'name', 'Updated');
                
                if (!changeDetected) {
                    log(resultsId, '✗ Change subscription failed', true);
                }
                
                // Test 5: Reset state
                StateManager.reset('testModule');
                const resetState = StateManager.get('testModule');
                
                if (resetState.count === 0 && resetState.name === 'Test') {
                    log(resultsId, '✓ State reset successfully');
                } else {
                    log(resultsId, '✗ State reset failed', true);
                }
                
                // Show all modules
                log(resultsId, `✓ Registered modules: ${StateManager.getModules().join(', ')}`);
                
            } catch (error) {
                log(resultsId, `✗ StateManager test error: ${error.message}`, true);
            }
        }
        
        // Test Constants
        function testConstants() {
            const resultsId = 'constants-results';
            
            try {
                // Test 1: Access highlight colors
                if (Constants.HIGHLIGHT_COLORS.yellow) {
                    log(resultsId, '✓ Highlight colors accessible');
                    logJson(resultsId, Constants.HIGHLIGHT_COLORS);
                } else {
                    log(resultsId, '✗ Highlight colors not found', true);
                }
                
                // Test 2: Check frozen state
                try {
                    Constants.HIGHLIGHT_COLORS.yellow = 'modified';
                    log(resultsId, '✗ Constants are not frozen!', true);
                } catch (e) {
                    log(resultsId, '✓ Constants are properly frozen');
                }
                
                // Test 3: Access other constants
                log(resultsId, `✓ Default color: ${Constants.DEFAULT_COLOR}`);
                log(resultsId, `✓ Storage key: ${Constants.STORAGE_KEY}`);
                log(resultsId, `✓ Z-index button: ${Constants.Z_INDEX.BUTTON}`);
                
                // Show UI constants
                log(resultsId, '✓ UI Constants:');
                logJson(resultsId, Constants.UI);
                
            } catch (error) {
                log(resultsId, `✗ Constants test error: ${error.message}`, true);
            }
        }
        
        // Run all tests
        testEventBus();
        testStateManager();
        testConstants();
        
        // Integration test
        setTimeout(() => {
            const integrationDiv = document.createElement('div');
            integrationDiv.className = 'test-section';
            integrationDiv.innerHTML = '<h2>Integration Test</h2><div id="integration-results"></div>';
            document.body.appendChild(integrationDiv);
            
            // Test modules working together
            StateManager.register('highlight', { 
                color: Constants.DEFAULT_COLOR,
                count: 0 
            });
            
            EventBus.on('highlight:created', (data) => {
                StateManager.set('highlight', {
                    color: data.color,
                    count: StateManager.get('highlight', 'count') + 1
                });
                
                log('integration-results', 
                    `✓ Integration test passed: Created ${data.color} highlight, total count: ${StateManager.get('highlight', 'count')}`);
            });
            
            // Simulate highlight creation
            EventBus.emit('highlight:created', { color: 'blue' });
            EventBus.emit('highlight:created', { color: 'green' });
            
        }, 100);
    </script>
</body>
</html>