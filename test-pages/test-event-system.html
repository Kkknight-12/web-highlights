<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event System Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      line-height: 1.6;
    }
    
    .test-section {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      background: #007bff;
      color: white;
      cursor: pointer;
    }
    
    button:hover {
      background: #0056b3;
    }
    
    #console {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    
    .log-entry {
      margin: 2px 0;
    }
    
    .log-info { color: #58a6ff; }
    .log-success { color: #3fb950; }
    .log-warn { color: #f0883e; }
    .log-error { color: #f85149; }
  </style>
</head>
<body>
  <h1>Chrome Extension Event System Test</h1>
  
  <div class="test-section">
    <h2>Test Controls</h2>
    <button onclick="runAllTests()">Run All Tests</button>
    <button onclick="testEventBus()">Test Event Bus</button>
    <button onclick="testComponents()">Test Components</button>
    <button onclick="testMemoryCleanup()">Test Memory Cleanup</button>
    <button onclick="clearConsole()">Clear Console</button>
  </div>
  
  <div class="test-section">
    <h2>Console Output</h2>
    <div id="console"></div>
  </div>

  <script type="module">
    // Import core modules
    import { eventBus, BaseComponent, EVENTS, componentRegistry } from './src/content/core/index.js'
    
    // Override console.log to display in our custom console
    const customConsole = document.getElementById('console')
    const originalLog = console.log
    const originalWarn = console.warn
    const originalError = console.error
    
    function logToCustomConsole(type, ...args) {
      const message = args.map(arg => 
        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
      ).join(' ')
      
      const entry = document.createElement('div')
      entry.className = `log-entry log-${type}`
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`
      customConsole.appendChild(entry)
      customConsole.scrollTop = customConsole.scrollHeight
    }
    
    console.log = (...args) => {
      originalLog(...args)
      logToCustomConsole('info', ...args)
    }
    
    console.warn = (...args) => {
      originalWarn(...args)
      logToCustomConsole('warn', ...args)
    }
    
    console.error = (...args) => {
      originalError(...args)
      logToCustomConsole('error', ...args)
    }
    
    // Test functions
    window.runAllTests = async function() {
      console.log('=== Running All Tests ===')
      await testEventBus()
      await testComponents()
      await testMemoryCleanup()
      console.log('=== All Tests Complete ===')
    }
    
    window.testEventBus = function() {
      console.log('--- Testing Event Bus ---')
      
      // Enable debug mode
      eventBus.setDebug(true)
      
      // Test basic event emission
      const handler = (event) => {
        console.log('Received event:', event.type, event.detail)
      }
      
      eventBus.on(EVENTS.SYSTEM.READY, handler)
      eventBus.emit(EVENTS.SYSTEM.READY, { message: 'System is ready!' })
      
      // Test once
      eventBus.once(EVENTS.UI.BUTTON_CLICKED, (event) => {
        console.log('Button clicked (once):', event.detail)
      })
      
      eventBus.emit(EVENTS.UI.BUTTON_CLICKED, { button: 1 })
      eventBus.emit(EVENTS.UI.BUTTON_CLICKED, { button: 2 }) // Should not trigger
      
      // Show stats
      console.log('Event Stats:', eventBus.getStats())
      
      // Cleanup
      eventBus.off(EVENTS.SYSTEM.READY, handler)
      eventBus.setDebug(false)
    }
    
    window.testComponents = async function() {
      console.log('--- Testing Components ---')
      
      // Create test component
      class TestComponent extends BaseComponent {
        constructor() {
          super('TestComponent')
          this.counter = 0
        }
        
        init() {
          console.log(`[${this.name}] Initialized`)
          this.on(EVENTS.UI.BUTTON_CLICKED, this.handleClick)
        }
        
        handleClick(event) {
          this.counter++
          console.log(`[${this.name}] Button clicked ${this.counter} times`)
          this.emit(EVENTS.UI.COLOR_SELECTED, { color: 'blue' })
        }
      }
      
      // Register and initialize
      const testComp = new TestComponent()
      componentRegistry.register('test', testComp)
      await componentRegistry.initialize('test')
      
      // Test events
      eventBus.emit(EVENTS.UI.BUTTON_CLICKED, { test: true })
      
      // Show component info
      console.log('Component Info:', testComp.getInfo())
      console.log('Registry Stats:', componentRegistry.getStats())
    }
    
    window.testMemoryCleanup = function() {
      console.log('--- Testing Memory Cleanup ---')
      
      // Create component with multiple listeners
      class LeakyComponent extends BaseComponent {
        init() {
          // Add many listeners
          for (let i = 0; i < 5; i++) {
            this.on(EVENTS.HIGHLIGHT.CREATED, () => {
              console.log(`Handler ${i} called`)
            })
          }
        }
      }
      
      const leaky = new LeakyComponent('LeakyComponent')
      componentRegistry.register('leaky', leaky)
      componentRegistry.initialize('leaky')
      
      console.log('Before cleanup:', leaky.getInfo())
      
      // Destroy and check
      componentRegistry.destroy('leaky')
      console.log('After cleanup - Is alive?', leaky.isAlive())
      
      // Try to emit after destroy (should warn)
      leaky.emit(EVENTS.HIGHLIGHT.CREATED, { test: 'should not work' })
    }
    
    window.clearConsole = function() {
      customConsole.innerHTML = ''
      console.log('Console cleared')
    }
    
    // Initial message
    console.log('Event System Test Page Loaded')
    console.log('Available test functions: runAllTests(), testEventBus(), testComponents(), testMemoryCleanup()')
  </script>
</body>
</html>